<div class="flex flex-col justify-between items-start p-3 sm:p-6">
  <button
    matButton
    (click)="goBack()"
    class="flex items-center gap-2 mb-4 sm:mb-6"
  >
    <mat-icon>arrow_back</mat-icon>
    <span class="hidden sm:inline">Voltar</span>
  </button>

  <section class="w-full mb-6 sm:mb-8">
    <span class="text-2xl sm:text-3xl">{{ ticketId ? 'Editar Ticket' : 'Novo Ticket' }}</span>
  </section>

  <section class="w-full">
    <form
      [formGroup]="form"
      class="space-y-4"
    >
      <input
        type="hidden"
        formControlName="ticketStatus"
        value="PENDING"
      />

      <mat-form-field
        appearance="outline"
        class="w-full"
      >
        <mat-label>Título</mat-label>
        <textarea
          matInput
          formControlName="title"
          placeholder="Ex. PC pifou após jogar água nele"
          rows="2"
          class="resize-none"
        ></textarea>
        @if (form.get('title')?.invalid) {
        <mat-error>{{ formUtils.getErrorMessage(form, "title") }}</mat-error>
        }
      </mat-form-field>

      <mat-form-field
        appearance="outline"
        class="w-full"
      >
        <mat-label>Descrição</mat-label>
        <textarea
          matInput
          formControlName="description"
          placeholder="Ex. Meu PC pifou..."
        ></textarea>
        @if (form.get('description')?.invalid) {
        <mat-error>{{ formUtils.getErrorMessage(form, "description") }}</mat-error>
        }
      </mat-form-field>

      <mat-form-field
        appearance="outline"
        class="w-full"
      >
        <mat-label>Categoria</mat-label>
        <mat-select formControlName="ticketCategoryId">
          @for (category of categories; track $index) {
          <mat-option [value]="category.ticketCategoryId">{{ category.description }}</mat-option>
          }
        </mat-select>
        @if (form.get('ticketCategoryId')?.invalid) {
        <mat-error>{{ formUtils.getErrorMessage(form, 'ticketCategoryId') }}</mat-error>
        }
      </mat-form-field>

      @if (showStatusField) {
      <mat-form-field
        appearance="outline"
        class="w-full"
      >
        <mat-label>Status</mat-label>
        <mat-select formControlName="ticketStatus">
          <mat-option value="PENDING">Pendente</mat-option>
          <mat-option value="ATTACHED">Atribuído</mat-option>
          <mat-option value="COMPLETED">Completo</mat-option>
          <mat-option value="STOPPED">Pausado</mat-option>
        </mat-select>
        @if (form.get('ticketStatus')?.invalid) {
        <mat-error>{{ formUtils.getErrorMessage(form, 'ticketStatus') }}</mat-error>
        }
      </mat-form-field>
      } @if (showAssignedField) {
      <mat-form-field
        appearance="outline"
        class="w-full"
      >
        <mat-label>Atribuído</mat-label>
        <mat-select formControlName="receiverId">
          <mat-option [value]="null">Não atribuído</mat-option>
          @for (technician of technicians; track technician.userId) {
          <mat-option [value]="technician.userId">{{ technician.name }}</mat-option>
          }
        </mat-select>
      </mat-form-field>
      }

      <div class="w-full">
        <app-image-upload
          [initialUrls]="existingImageUrls()"
          [readonly]="!canEditAttachments"
          (filesSelected)="selectedFiles.set($event)"
        />
      </div>

      @if (canCreateTicket || isTechnician || isAdmin || isUser) {
      <div class="flex flex-col sm:flex-row justify-end gap-4 pt-4">
        <button
          matButton="filled"
          class="w-full sm:w-28 min-h-[44px]"
          (click)="onSubmit()"
          [disabled]="form.invalid || loading()"
        >
          @if (loading()) {
          <mat-progress-spinner
            diameter="20"
            mode="indeterminate"
            color="primary"
            class="mr-2"
            style="vertical-align: middle"
          ></mat-progress-spinner>
          } @else { {{ ticketId ? 'Salvar' : 'Criar' }} }
        </button>
      </div>
      }
    </form>
  </section>
</div>
