<div class="max-w-4xl mx-auto p-6">
  <div class="flex justify-between items-center mb-6">
    <button
      matButton
      (click)="goBack()"
      class="flex items-center gap-2"
    >
      <mat-icon>arrow_back</mat-icon>
      Voltar
    </button>

    <button
      mat-raised-button
      color="primary"
      (click)="editTicket()"
      class="flex items-center gap-2"
    >
      <mat-icon>edit</mat-icon>
      Editar
    </button>
  </div>

  <mat-card class="mb-6">
    <mat-card-header class="mb-4">
      <mat-card-title class="text-xl font-semibold">
        {{ ticket?.title }}
        <span class="text-gray-600">#{{ ticket?.ticketId }}</span>
      </mat-card-title>
      <mat-chip class="ml-2">{{ ticket?.ticketStatus }}</mat-chip>
    </mat-card-header>

    <mat-card-content>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
        <div class="space-y-4">
          <div class="flex items-center gap-3">
            <mat-icon class="text-gray-500">category</mat-icon>
            <div>
              <p class="text-sm text-gray-600 font-medium">Categoria</p>
              <p class="text-base">{{ ticketCategory }}</p>
            </div>
          </div>

          <div class="flex items-center gap-3">
            <mat-icon class="text-gray-500">schedule</mat-icon>
            <div>
              <p class="text-sm text-gray-600 font-medium">Data de criação</p>
              <p class="text-base">{{ ticket?.timestamp | date: 'dd/MM/yyyy HH:mm' }}</p>
            </div>
          </div>
        </div>

        <div class="space-y-4">
          <div class="flex items-center gap-3">
            <mat-icon class="text-gray-500">person</mat-icon>
            <div>
              <p class="text-sm text-gray-600 font-medium">Criado por</p>
              <p class="text-base">ID: {{ ticket?.senderId }}</p>
            </div>
          </div>

          @if (ticket?.receiverId) {
          <div class="flex items-center gap-3">
            <mat-icon class="text-gray-500">support_agent</mat-icon>
            <div>
              <p class="text-sm text-gray-600 font-medium">Atribuído para</p>
              <p class="text-base">ID: {{ ticket?.receiverId }}</p>
            </div>
          </div>
          }
        </div>
      </div>

      <mat-divider></mat-divider>

      <div class="my-6">
        <h3 class="text-lg mb-1 flex items-center gap-2">
          <mat-icon>description</mat-icon>
          Descrição
        </h3>
        <div class="bg-gray-50 py-2 rounded-lg">
          <p class="text-gray-800 whitespace-pre-wrap">{{ ticket?.description || 'Nenhuma descrição fornecida' }}</p>
        </div>
      </div>

      @if (ticketImages && ticketImages.length > 0) {
      <div class="mb-6">
        <h3 class="text-lg mb-3 flex items-center gap-2">
          <mat-icon>image</mat-icon>
          Imagens anexadas
          <mat-chip class="ml-2">{{ ticketImages.length }}</mat-chip>
        </h3>
        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
          @for (image of ticketImages; track $index) {
          <div class="relative group cursor-pointer overflow-hidden rounded-lg border hover:shadow-lg transition-shadow">
            <img
              [src]="image"
              [alt]="'Imagem ' + ($index + 1)"
              class="w-full h-32 object-cover group-hover:scale-105 transition-transform duration-300"
            />
            <div
              class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-20 transition-opacity duration-300 flex items-center justify-center"
            >
              <mat-icon class="text-white opacity-0 group-hover:opacity-100 transition-opacity duration-300">zoom_in</mat-icon>
            </div>
          </div>
          }
        </div>
      </div>
      } @if (ticket?.ratingId) {
      <mat-divider class="my-6"></mat-divider>
      <div class="flex items-center gap-3">
        <mat-icon class="text-yellow-500">star</mat-icon>
        <div>
          <p class="text-sm text-gray-600 font-medium">Avaliação</p>
          <p class="text-base">{{ ticket?.ratingId }}</p>
        </div>
      </div>
      }
    </mat-card-content>
  </mat-card>
</div>

<div class="max-w-4xl mx-auto p-6">
  <mat-card class="mb-6">
    <mat-card-header>
      <mat-card-title class="text-xl font-semibold">Mensagens</mat-card-title>
    </mat-card-header>

    <mat-card-content class="flex flex-col min-h-0 mt-4">
      @if (isLoadingMessages && (!ticketMessages || ticketMessages.length === 0)) {
      <div class="flex justify-center items-center py-12">
        <div class="text-center flex flex-col items-center">
          <mat-progress-spinner
            diameter="40"
            mode="indeterminate"
            color="primary"
          ></mat-progress-spinner>
          <p class="text-gray-600 mt-3 text-sm">Carregando mensagens...</p>
        </div>
      </div>
      } @else if (ticketMessages && ticketMessages.length > 0) {

      <div class="flex-1 min-h-0 mb-4">
        <div
          #messagesContainer
          class="messages-container space-y-4 p-2 h-full overflow-y-auto"
        >
          @for (message of ticketMessages; track message.messageId === -1 ? message.timestamp : message.messageId) {
          <div
            class="message-item p-4 rounded-lg border relative shadow-sm"
            [class.opacity-70]="message.messageId === -1"
            [class.bg-blue-100]="message.messageId === -1"
            [class.border-blue-300]="message.messageId === -1"
            [class.bg-gray-100]="message.messageId !== -1"
            [class.border-gray-300]="message.messageId !== -1"
          >
            <div class="flex items-start gap-3 mb-2">
              <div class="flex items-center gap-2">
                <span class="font-semibold text-gray-900">{{ message.senderId }}</span>
              </div>
              <span class="text-sm text-gray-500 ml-auto">{{ message.timestamp | date: 'dd/MM/yyyy HH:mm' }}</span>
            </div>
            <p class="text-gray-800 whitespace-pre-wrap leading-relaxed">{{ message.message }}</p>

            @if (message.messageId === -1) {
            <div class="absolute bottom-2 right-3 flex items-center gap-1 text-xs text-blue-600">
              <mat-icon
                class="text-blue-500 animate-spin"
                style="font-size: 14px; width: 14px; height: 14px"
              >
                refresh
              </mat-icon>
              <span>Enviando...</span>
            </div>
            }
          </div>
          }
        </div>
      </div>
      } @else {
      <div class="text-center py-8">
        <mat-icon class="text-gray-400 text-4xl mb-2">chat_bubble_outline</mat-icon>
        <p class="text-gray-600">Nenhuma mensagem ainda.</p>
        <p class="text-sm text-gray-500">Seja o primeiro a comentar neste ticket!</p>
      </div>
      }

      <mat-divider class="my-6"></mat-divider>

      <form
        [formGroup]="messageForm"
        (ngSubmit)="sendMessage()"
        class="message-form"
      >
        <div class="flex gap-4 items-start">
          <mat-form-field
            appearance="outline"
            class="flex-1"
          >
            <mat-label>Digite sua mensagem</mat-label>
            <textarea
              matInput
              formControlName="message"
              rows="3"
              placeholder="Adicione um comentário..."
              class="resize-none"
              (keydown)="onKeydown($event)"
            ></textarea>
            <mat-hint>Pressione Ctrl+Enter para enviar</mat-hint>
            @if (messageForm.get('message')?.hasError('required')) {
            <mat-error>Mensagem é obrigatória</mat-error>
            }
          </mat-form-field>
          <button
            mat-raised-button
            color="primary"
            type="submit"
            [disabled]="messageForm.invalid"
            class="mt-1"
            style="height: 56px; min-width: 100px"
          >
            <mat-icon class="mr-1">send</mat-icon>
            Enviar
          </button>
        </div>
      </form>
    </mat-card-content>
  </mat-card>
</div>
